# 技术方案 V1

@Joe Sanchez 

---

## 一、目标与范围（MVP）

**产品目标（对齐产品文档）**

- 在 8 周内做出可上线获客的 V1，核心价值：
    - AI 选校 & 规划
    - 语言训练基础 Demo（雅思口语/写作）
- 覆盖右侧原型流程：
    1. Page1：用户档案填写（学术 / 背景 / 语言水平等）
    2. Page2：智能选校结果列表 + 匹配度标签 + 差距分析 + AI 建议区
    3. 学校详情卡片：单校详细推荐理由与差距
    4. 体验问卷：记录用户反馈，用于算法迭代与留存

**非功能目标**

- 能支撑前 50–200 名真实用户内测，且：
    - 选校结果稳定可跑
    - LLM 调用有监控和限流
    - 数据结构为后续扩展（更多国家、路径、导师系统）留好空间

## 二、整体技术架构

### 2.1 架构分层

1. **前端 Web（Nextjs /React+ TypeScript + TailwindCSS）**
    - 职责：实现原型里的所有页面 & 交互
    - 模块：
        - 档案表单页（Page1）
        - 选校结果与差距分析页（Page2 Dashboard）
        - 学校详情卡片弹窗 / 独立页
        - 问卷与反馈页
        - 简单登录/注册页
2. **后端 API 服务（FastAPI, 单体分模块）**
    - 模块划分：
        - `auth`：注册登录、JWT、第三方登录预留
        - `profile`：用户档案管理
        - `school`：学校数据管理与查询
        - `recommendation`：选校计算、结果存储与查询
        - `gap_analysis`：差距分析结构计算
        - `feedback`：问卷与使用反馈
        - `ielts_training`：雅思训练 Demo（LLM 接口）
        - `llm_proxy`：统一封装大模型调用
3. **AI / 推荐层**
    - **规则 + 打分引擎（本地逻辑）**
        - 根据用户档案对学校进行粗排：筛选国家/专业/预算/排名区间等（调用 PostgreSQL 结构化查询）
        - 计算基础匹配分（0–100）：学术、语言、专业匹配度、预算匹配度
        - 给出不同方案的匹配度，~~并标记 Reach / Match / Safe~~
    - **Agent 编排（Agentic RAG）**
        - 作为“推荐编排中枢”，调用多个工具（Tools）完成择校流程：
            - **StructuredFilterTool**：基于结构化条件（国家/地区、学位类型、学费区间、排名区间等）调用 PostgreSQL，对院校/项目做候选集初筛（例如筛出 Top 200 个候选 program_id）。
            - **VectorSearchTool**：将用户意向描述 + 背景信息转成查询向量，调用向量数据库（Qdrant/Milvus），在候选集中做语义检索和重排，用于发现“隐性匹配”的院校项目（如“偏量化金融”“跨学科项目”等）。
            - **ScoringTool**：综合结构化得分 + 语义相似度得分，计算最终匹配分与标签（Reach/Match/Safe）。
            - **ExplanationRAGTool**：基于向量库检索到的项目介绍/课程描述文本 + 结构化字段，调用大模型生成“推荐理由”“差距分析说明”“择校项目报告”等自然语言结果。
        - Agent 对外只暴露一个推荐 API，对前端与其他服务透明内部调用逻辑。
    - **IELTS 训练 Agent**
        - 提供雅思训练对话接口（写作点评/口语模拟），与择校 Agent 共享统一的 llm_proxy 与日志监控能力。
4. **数据存储层**
    - 关系型数据库：PostgreSQL
        - 存用户档案、学校信息、项目结构化字段、推荐结果、日志等
    - 缓存：Redis
        - 热门学校数据缓存、推荐结果缓存、会话 Token
    - 向量数据库: Qdrant/Mlivus
        - 存学校与项目的介绍文本、课程描述等的向量表示，payload 中保留 `program_id`/`school_id` 等结构化主键，用于与 PostgreSQL 进行双向关联，支撑 Agentic RAG 与语义检索。**
    - 关系型数据库：MySQL / PostgreSQL
        - 存用户档案、学校信息、推荐结果、日志等
    - 缓存：Redis
        - 热门学校数据缓存、推荐结果缓存、会话 Token
    - 向量数据库: Qdrant/Mlivus
        - 存学校介绍、文本，用于语义检索更细致匹配
5. **基础设施**
    - 部署：Docker + 云服务器（例如阿里云 / 腾讯云）
    - 网关 / Nginx：反向代理、HTTPS、静态资源托管
    - 监控：Prometheus + Grafana / 云厂商监控
    - 日志：结构化日志（请求日志、LLM 调用日志）

## 三、推荐择校机制设计（PostgreSQL + Vector DB + Agentic RAG）

![image.png](image.png)

### 3.1 数据分层与职责

- **PostgreSQL（结构化层）**
    - 存储用户档案（GPA、语言成绩、目标国家/学位等）、学校与项目结构化字段（国家、城市、排名、学费、语言/GPA 要求等）。
    - 对外提供高效的条件过滤与排序能力，是候选集生成与规则打分的主数据源。
- **向量数据库 Qdrant/Milvus（语义层）**
    - 存储项目相关的非结构化文本（项目简介、课程描述、培养目标等）的向量表示，向量记录中以 `program_id` 作为主键或 payload 字段，与 PostgreSQL 中的 `programs` 表一一对应。
    - 提供语义检索与相似度排序能力，是“自然语言找项目”“隐藏匹配发现”的核心能力。

### 3.2 Agent 驱动的两阶段推荐流程

1. **阶段一：结构化初筛（Structured Filtering）**
    - Agent 解析用户档案（profile）与即时意图（如“只看英国”“偏量化”）。
    - 调用 `StructuredFilterTool`：
        - 翻译为结构化过滤条件（国家/地区、学位类型、预算区间、排名区间、语言与 GPA 下限等）。
        - 在 PostgreSQL 中执行查询，得到一个较大的候选集（如 100–300 个 program）。
    - 在当前阶段，仅基于结构化数据对候选集匹配，完成项目的初步筛选，先得到一版结构化的候选项目清单；在下一阶段，再由 Agentic RAG 基于向量库检索更详细的项目入学文档与描述，用于生成最终的匹配度打分、推荐理由和差距分析。
2. **阶段二：Agentic RAG 语义校准（Semantic Re-ranking）**
    - 在本阶段，Agent 基于用户自然语言描述与档案信息执行语义检索与深度匹配，但需要明确的是：**最终的匹配度打分、推荐理由与差距分析均将在此阶段完成，而非前一阶段的结构化初筛中得出**。
    - Agent 首先基于用户输入构造语义查询向量（例如：“英国 偏量化 金融 硕士 有编程课程 有实习机会”）。
    - 调用 `VectorSearchTool`：
        - 在向量库中检索更丰富的项目文档（如项目课程、亮点、培养目标、录取偏好等）。
        - 使用 `program_id` 或国家/学位作为过滤条件，限定在阶段一结构化初筛的候选集内进行语义比对。
        - 获得每个 program 的语义相似度得分。
    - 调用 `ScoringTool`：
        - 将结构化初筛阶段得到的基础数据与向量检索得到的语义信息综合计算，生成**最终的匹配度得分**。
        - 生成这一阶段的核心结果：**最终推荐理由、匹配亮点以及针对语言/GPA/背景等维度的差距分析**。
    - 完整语义校准的结果将替代初筛阶段的粗略标签，使系统能够发现“结构化上看似合适但文本语义更匹配”的项目，以及“结构化达线但语义偏差较大”的项目，从而提升推荐可信度与解释力。
3. **RAG 生成推荐解释与差距分析**
    - Agent 调用 `ExplanationRAGTool`：
        - 对于最终 Top N 院校：
            - 从向量库中检索该项目相关的描述文本片段（项目亮点、课程模块、毕业去向等）。
            - 结合 PostgreSQL 中的结构化字段与用户档案，拼装成一组上下文文档。
        - 通过 llm_proxy 调用大模型，在上下文约束下生成：
            - 单校的“推荐理由”和“适配点亮点”；
            - 针对语言/GPA/背景的“差距清单”和改善建议；
            - 面向用户的一份“择校项目报告”总览文本。
    - 生成结果以 JSON 结构形式返回后端，由后端持久化到推荐结果表中，前端按模块化方式渲染。

### 3.3 与前端交互的接口视角

- 对前端而言，择校流程只需调用少量 REST API：
    - `POST /api/recommendations`：发起一轮推荐，Agent 在后台完成结构化初筛 + 向量检索 + RAG 生成。
    - `GET /api/recommendations/{id}`：获取本轮推荐结果列表（包含匹配度、Reach/Match/Safe 标签等）。
    - `GET /api/recommendations/{id}/items/{item_id}`：获取某所学校的详细推荐理由与差距分析（由 RAG 生成）。
- Agent 内部如何组合 PostgreSQL 与向量库，对前端完全透明，便于后续替换/升级向量库或推荐算法，而不影响产品界面与交互。

### 3.4 扩展与演进

- 在数据量较小的 MVP 阶段，可优先支持“候选集内语义重排”，降低向量检索压力，减少 Qdrant/Milvus 资源消耗。
- 当学校与项目规模扩大，或需要支持“纯自然语言找项目”（不依赖结构化初筛）时，可在 Agent 中增加“全量向量检索模式”，并通过缓存/分片等方式优化性能。
- 向量库与 PostgreSQL 之间通过 `program_id`/`school_id` 保持强关联，未来可在不改动业务表结构的前提下替换向量引擎（如从 Qdrant 切换到 Milvus 或 pgvector）。

## 四、关键业务流程与接口设计

### 4.1 Page1：用户档案信息采集

**流程**

1. 用户登录/注册
2. 填写基本信息：学历、专业、GPA、在读/毕业学校、目标国家/地区、预算、语言成绩、工作背景等（原型中左上两大块「商科/理工」+「留学目的」）
3. 提交后调用后端创建/更新档案
4. 后端触发异步选校任务，或者同步返回第一版推荐结果 ID

**核心接口**

- `POST /api/auth/register`
- `POST /api/auth/login`
- `GET /api/profile/me`
- `PUT /api/profile/me`
- `GET /api/meta/options`
    
    返回专业列表、国家、学位类型等下拉选项
    

### 4.2 Page2：选校结果 + 差距分析 + AI 建议区

对应你原型中央的大面板 + 右侧 AI 文本框。

**前端展示结构**

- 顶部：筛选标签（按 匹配度、国家、专业等过滤）
- 中间：学校卡片网格
- 右侧：
    - AI 总结（本轮推荐的整体建议）
    - 文本框支持用户“追问”：如“如果我只想去英国呢？”

**后端流程**

1. 前端请求：`POST /api/recommendations`（传 user_id 或默认当前用户）
2. 后端执行：
    - 从 DB 取用户档案
    - 粗筛候选学校（按国家/专业/排名范围等）
    - 调用 Agent：
        - 输入：用户档案 + Top N 学校结构化数据(来自粗排的候选集)
        - 输出：每所学校的 JSON 说明 + 总体建议 + 差距总结
    - 将结果写入 `recommendations` + `recommendation_items` 表
3. 前端再用：`GET /api/recommendations/{id}` 分页展示

**接口示例**

- `POST /api/recommendations`
- `GET /api/recommendations/{id}`
- `GET /api/recommendations/{id}/items?level=match`

### 4.3：中间：学校卡片网格 - 单个学校详情卡片

对应左下「仅从一张卡片就能评价一所学校」的那块。

**展示内容**

- 学校基本信息：名称、国家、城市、QS 排名、学费
- 对应专业信息：项目名称、学制、语言要求（雅思/托福）、背景偏好
- AI 推荐理由：为啥适合/不适合你
- 差距清单：GPA 差多少、语言差多少、背景经历差在哪（实习/科研等）

### 4.4: Page3 差距分析 & 行动清单页面

该页面由用户在 Page2 中点击某个项目卡片后进入，用于基于单个项目的差距分析结果，为学生生成一份“可行清单”，同时作为后续导师平台/合作机构的转化入口。

对应原型中的文案：

> 学生可以点选自己最想去的学校，AI 会根据学生的现状为学生制定基础的可行清单…… “XXX，要进入 XXX 大学，你目前可以做的准备是这些”。
> 

**核心目标**

- 根据该项目的差距分析结果，生成结构化的个性化行动建议（可行清单），例如：
    - 提升雅思成绩
    - 参与科研/项目
    - 寻找相关实习
    - 咨询文书老师
    - 咨询机构导师
- 将每个行动点与内部业务跳转打通：
    - 「去提高」→ 跳转到自有导师平台/课程页
    - 「去咨询」→ 跳转到顾问/机构线索收集或咨询入口
- 记录用户对行动项的选择偏好，用于后续产品迭代与业务转化分析。

**前端展示结构**

- 顶部：说明文案（"XXX，要进入 XXX 大学，你目前可以做的准备是这些"）。
- 中部：若干行动选项列表，每一项包括：
    - 行动名称（如“雅思成绩提高”）
    - 简短说明（如“建议在 3 个月内将总分从 6.0 提升到 6.5+”）
    - 可选跳转链接按钮（如“去提升〈跳转我们的导师平台〉”）。
- 底部：确认/保存按钮，记录用户勾选的行动项，或引导用户进一步沟通（如预约顾问）。

**后端流程与接口**

1. 获取单项目行动清单
    - `GET /api/recommendations/{rec_id}/items/{item_id}/plan`
    - 返回内容：
        - 项目信息概要（学校名、专业名、项目基本要求）
        - 由前一阶段差距分析/Agent 生成的结构化行动清单（列表，每项包含：类型、标题、说明文案、推荐完成时间、跳转链接等）。
2. 记录用户选择与行为埋点
    - `POST /api/recommendations/{rec_id}/items/{item_id}/plan/selection`
    - 请求体示例：
        - `selected_actions`: ["improve_ielts", "find_internship"]
        - `from_page`: "page3"
    - 作用：
        - 统计用户对不同行动项的偏好
        - 为后续业务转化（如顾问跟进）提供线索
3. 业务跳转（非必须接口）
    - 对接内部导师平台/机构平台时，可在行动清单中预置 `redirect_url`，前端直接使用链接跳转，同时通过上述 selection 接口完成埋点。